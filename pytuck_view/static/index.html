<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pytuck-view - æ•°æ®åº“æŸ¥çœ‹å™¨</title>
    <link rel="stylesheet" href="/static/app.css">
    <style>
        /* å†…è”å…³é”® CSS ä»¥åŠ å¿«åŠ è½½é€Ÿåº¦ */
        #app {
            min-height: 100vh;
        }

        /* æ–‡ä»¶æµè§ˆå™¨æ¨¡æ€æ¡†æ ·å¼ */
        .file-browser-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .file-browser-modal {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .file-browser-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .file-browser-header h2 {
            margin: 0;
            font-size: 18px;
        }

        .file-browser-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .file-browser-close:hover {
            background: #f0f0f0;
            color: #333;
        }

        .file-browser-controls {
            padding: 12px 20px;
            border-bottom: 1px solid #e0e0e0;
            background: #f9f9f9;
        }

        .file-browser-path-input {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .file-browser-path-input input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .file-browser-path-input button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .file-browser-path-input button:hover {
            background: #0056b3;
        }

        .file-browser-breadcrumb {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-wrap: wrap;
            font-size: 14px;
        }

        .breadcrumb-item {
            cursor: pointer;
            color: #007bff;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .breadcrumb-item:hover {
            background: #e7f3ff;
        }

        .breadcrumb-separator {
            color: #999;
        }

        .file-browser-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px 20px 20px;
        }

        .file-browser-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .file-browser-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-browser-item:hover {
            background: #f5f5f5;
            border-color: #007bff;
        }

        .file-browser-item-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .file-browser-item-icon {
            font-size: 24px;
        }

        .file-browser-item-name {
            font-weight: 500;
        }

        .file-browser-item-meta {
            color: #666;
            font-size: 13px;
            margin-top: 4px;
        }

        .file-browser-item-action {
            padding: 6px 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        .file-browser-item-action:hover {
            background: #218838;
        }

        .file-browser-empty {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- æ–‡ä»¶é€‰æ‹©å™¨é¡µé¢ -->
        <div v-if="state.currentPage === 'file-selector'" class="file-selector">
            <header class="header">
                <h1>ğŸ“Š pytuck-view</h1>
                <p>é€‰æ‹©ä¸€ä¸ª pytuck æ•°æ®åº“æ–‡ä»¶å¼€å§‹æµè§ˆ</p>
            </header>

            <!-- é”™è¯¯æç¤º -->
            <div v-if="state.error" class="error">
                âŒ {{ state.error }}
                <button @click="state.error = null">Ã—</button>
            </div>

            <!-- å ä½ç¬¦åŠŸèƒ½è­¦å‘Š -->
            <div v-if="state.placeholderWarning" class="warning">
                âš ï¸ {{ state.placeholderWarning }}
                <button @click="state.placeholderWarning = null">Ã—</button>
            </div>

            <div class="quick-actions">
                <button @click="openFileBrowser" class="btn btn-primary" :disabled="state.loading">
                    ğŸ“ æµè§ˆç›®å½•
                </button>
            </div>

            <!-- å†å²æ–‡ä»¶ï¼ˆå¡ç‰‡ï¼‰ -->
            <section v-if="state.recentFiles.length > 0" class="file-section">
                <h2>ğŸ“‹ å†å²æ–‡ä»¶</h2>
                <div class="file-cards">
                    <div v-for="file in state.recentFiles" :key="file.file_id" class="file-card" @click="openFile(file.path)">
                        <div class="file-card-header">
                            <div class="file-card-title">
                                <span class="file-card-name">{{ file.name }}</span>
                                <span v-if="file.engine_name" class="engine-tag">{{ file.engine_name }}</span>
                            </div>
                            <button class="file-card-remove" title="ç§»é™¤" @click.stop="removeHistory(file.file_id)">Ã—</button>
                        </div>
                        <div class="file-card-path">{{ file.path }}</div>
                        <div class="file-card-meta">
                            {{ formatFileSize(file.file_size) }} â€¢ {{ formatDate(file.last_opened) }}
                        </div>
                    </div>
                </div>
            </section>

            <!-- ç©ºçŠ¶æ€ -->
            <div v-if="!state.loading && state.recentFiles.length === 0" class="empty-state">
                <p>ğŸ“ è¿˜æ²¡æœ‰æ·»åŠ è¿‡æ–‡ä»¶</p>
                <p>ç‚¹å‡»"æµè§ˆç›®å½•"é€‰æ‹©ä¸€ä¸ª pytuck æ•°æ®åº“æ–‡ä»¶å¼€å§‹</p>
            </div>
        </div>

        <!-- æ•°æ®åº“æŸ¥çœ‹é¡µé¢ -->
        <div v-else-if="state.currentPage === 'database-view'" class="database-view">
            <header class="header">
                <button @click="backToFileSelector" class="btn btn-back">â† è¿”å›</button>
                <div class="db-info">
                    <h1>ğŸ“Š {{ state.currentDatabase.name }}</h1>
                    <p>{{ state.currentDatabase.tables_count }} å¼ è¡¨ â€¢ {{ formatFileSize(state.currentDatabase.file_size) }}</p>
                </div>
            </header>

            <!-- å ä½ç¬¦åŠŸèƒ½è­¦å‘Šï¼ˆæ•°æ®åº“é¡µé¢ï¼‰ -->
            <div v-if="state.placeholderWarning" class="warning">
                âš ï¸ {{ state.placeholderWarning }}
                <button @click="state.placeholderWarning = null">Ã—</button>
            </div>

            <div class="main-content">
                <!-- ä¾§è¾¹æ  - è¡¨åˆ—è¡¨ -->
                <aside class="sidebar">
                    <h3>ğŸ“‹ æ•°æ®è¡¨</h3>
                    <div class="table-list">
                        <div v-for="table in state.tables" :key="table"
                             class="table-item"
                             :class="{
                                active: state.currentTable === table,
                                placeholder: table.startsWith('âš ï¸') || table.startsWith('ğŸ’¡') || table.startsWith('ğŸ“‹')
                             }"
                             @click="selectTable(table)">
                            {{ table }}
                        </div>
                    </div>
                </aside>

                <!-- ä¸»å†…å®¹åŒº -->
                <main class="content">
                    <div v-if="!state.currentTable" class="welcome">
                        <h2>ğŸ‘ˆ é€‰æ‹©ä¸€ä¸ªè¡¨å¼€å§‹æµè§ˆ</h2>
                    </div>

                    <div v-else>
                        <!-- è¡¨ä¿¡æ¯ -->
                        <div v-if="state.tableSchema" class="table-info">
                            <h2>ğŸ“Š {{ state.tableSchema.table_name }}</h2>
                            <p>{{ state.tableSchema.row_count }} è¡Œæ•°æ®</p>
                        </div>

                        <!-- Tab -->
                        <div class="tab-bar">
                            <button class="tab" :class="{active: state.activeTab === 'structure'}" @click="state.activeTab = 'structure'">ç»“æ„</button>
                            <button class="tab" :class="{active: state.activeTab === 'data'}" @click="switchToDataTab">æ•°æ®</button>
                        </div>

                        <!-- ç»“æ„ Tab -->
                        <div v-if="state.activeTab === 'structure'" class="schema">
                            <h3>ğŸ”§ è¡¨ç»“æ„</h3>
                            <div v-if="state.tableSchema && state.tableSchema.columns" class="schema-table-wrapper">
                                <table class="schema-table">
                                    <thead>
                                        <tr>
                                            <th>åˆ—å</th>
                                            <th>æ•°æ®ç±»å‹</th>
                                            <th>å…è®¸ç©ºå€¼</th>
                                            <th>ä¸»é”®</th>
                                            <th>é»˜è®¤å€¼</th>
                                            <th>å¤‡æ³¨</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="col in state.tableSchema.columns" :key="col.name">
                                            <td class="col-name-cell">
                                                {{ col.name }}
                                            </td>
                                            <td class="col-type-cell">{{ col.type }}</td>
                                            <td class="col-nullable-cell">
                                                {{ col.nullable !== false ? 'æ˜¯' : 'å¦' }}
                                            </td>
                                            <td class="col-pk-cell">
                                                <span v-if="col.primary_key" class="pk-badge">ğŸ”‘</span>
                                                <span v-else>-</span>
                                            </td>
                                            <td class="col-default-cell">
                                                {{ col.default_value || '-' }}
                                            </td>
                                            <td class="col-comment-cell">
                                                {{ col.comment || '-' }}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- æ•°æ® Tab -->
                        <div v-else class="data-tab">
                            <!-- æ•°æ®è¡¨æ ¼ -->
                            <div v-if="hasData" class="data-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th v-for="col in state.tableSchema.columns" :key="col.name"
                                                @click="sortTable(col.name)"
                                                class="sortable">
                                                {{ col.name }}
                                                <span v-if="state.sortBy === col.name">
                                                    <span v-if="state.sortOrder === 'asc'">â†‘</span>
                                                    <span v-else>â†“</span>
                                                </span>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="(row, index) in state.tableData" :key="index">
                                            <td v-for="col in state.tableSchema.columns" :key="col.name">
                                                {{ row[col.name] }}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- åˆ†é¡µ -->
                            <div v-if="totalPages > 1" class="pagination">
                                <button @click="goToPage(1)" :disabled="state.currentPageNum === 1">é¦–é¡µ</button>
                                <button @click="goToPage(state.currentPageNum - 1)" :disabled="state.currentPageNum === 1">ä¸Šä¸€é¡µ</button>
                                <span>ç¬¬ {{ state.currentPageNum }} / {{ totalPages }} é¡µ</span>
                                <button @click="goToPage(state.currentPageNum + 1)" :disabled="state.currentPageNum === totalPages">ä¸‹ä¸€é¡µ</button>
                                <button @click="goToPage(totalPages)" :disabled="state.currentPageNum === totalPages">å°¾é¡µ</button>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <!-- æ–‡ä»¶æµè§ˆå™¨æ¨¡æ€æ¡† -->
        <div v-if="fileBrowser.visible" class="file-browser-overlay" @click.self="closeFileBrowser">
            <div class="file-browser-modal">
                <div class="file-browser-header">
                    <h2>ğŸ“ é€‰æ‹©æ•°æ®åº“æ–‡ä»¶</h2>
                    <button class="file-browser-close" @click="closeFileBrowser">Ã—</button>
                </div>

                <div class="file-browser-controls">
                    <div class="file-browser-path-input">
                        <input
                            v-model="fileBrowser.pathInput"
                            @keyup.enter="goToPath"
                            placeholder="è¾“å…¥è·¯å¾„ç›´æ¥è·³è½¬..."
                        />
                        <button @click="goToPath">å‰å¾€</button>
                    </div>

                    <div class="file-browser-breadcrumb">
                        <span
                            v-for="(part, index) in breadcrumbs"
                            :key="index"
                        >
                            <span class="breadcrumb-item" @click="goToBreadcrumb(index)">
                                {{ part.name }}
                            </span>
                            <span v-if="index < breadcrumbs.length - 1" class="breadcrumb-separator">/</span>
                        </span>
                    </div>
                </div>

                <div class="file-browser-content">
                    <div v-if="fileBrowser.loading" style="text-align: center; padding: 40px;">
                        åŠ è½½ä¸­...
                    </div>

                    <ul v-else-if="fileBrowser.entries.length > 0" class="file-browser-list">
                        <!-- ä¸Šçº§ç›®å½• -->
                        <li v-if="canGoUp" class="file-browser-item" @click="goUp">
                            <div class="file-browser-item-info">
                                <span class="file-browser-item-icon">ğŸ“</span>
                                <div>
                                    <div class="file-browser-item-name">..</div>
                                    <div class="file-browser-item-meta">ä¸Šçº§ç›®å½•</div>
                                </div>
                            </div>
                        </li>

                        <!-- ç›®å½•å’Œæ–‡ä»¶ -->
                        <li
                            v-for="entry in fileBrowser.entries"
                            :key="entry.path"
                            class="file-browser-item"
                            @click="entry.type === 'dir' ? browseTo(entry.path) : null"
                        >
                            <div class="file-browser-item-info">
                                <span class="file-browser-item-icon">
                                    {{ entry.type === 'dir' ? 'ğŸ“' : 'ğŸ“„' }}
                                </span>
                                <div>
                                    <div class="file-browser-item-name">{{ entry.name }}</div>
                                    <div class="file-browser-item-meta">
                                        {{ entry.type === 'file' ? formatFileSize(entry.size) : '' }}
                                    </div>
                                </div>
                            </div>
                            <button
                                v-if="entry.type === 'file'"
                                class="file-browser-item-action"
                                @click.stop="selectAndOpenFile(entry.path)"
                            >
                                æ‰“å¼€
                            </button>
                        </li>
                    </ul>

                    <div v-else class="file-browser-empty">
                        <p>ğŸ“‚ è¯¥ç›®å½•ä¸ºç©ºæˆ–æ²¡æœ‰æ•°æ®åº“æ–‡ä»¶</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- å…¨å±€åŠ è½½çŠ¶æ€ -->
        <div v-if="state.loading" class="loading-overlay">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <!-- Vue.js 3.x æœ¬åœ°æ–‡ä»¶ -->
    <script src="/static/vue.min.js"></script>

    <script>
        const { createApp, ref, reactive, computed, onMounted, nextTick } = Vue;

        createApp({
            setup() {
                // å“åº”å¼æ•°æ®
                const state = reactive({
                    currentPage: 'file-selector', // 'file-selector', 'database-view'
                    recentFiles: [],
                    currentDatabase: null,
                    tables: [],
                    currentTable: null,
                    activeTab: 'structure', // 'structure' | 'data'
                    tableSchema: null,
                    tableData: [],
                    currentPageNum: 1,
                    totalRows: 0,
                    rowsPerPage: 50,
                    loading: false,
                    error: null,
                    placeholderWarning: null,
                    sortBy: null,
                    sortOrder: 'asc'
                });

                // æ–‡ä»¶æµè§ˆå™¨çŠ¶æ€
                const fileBrowser = reactive({
                    visible: false,
                    path: "",
                    pathInput: "",
                    entries: [],
                    loading: false
                });

                // è®¡ç®—å±æ€§
                const totalPages = computed(() => {
                    return Math.ceil(state.totalRows / state.rowsPerPage);
                });

                const hasData = computed(() => {
                    return state.tableData && state.tableData.length > 0;
                });

                const breadcrumbs = computed(() => {
                    if (!fileBrowser.path) return [];

                    const parts = fileBrowser.path.split(/[/\\]/).filter(p => p);
                    const crumbs = [];

                    // Windows é©±åŠ¨å™¨å¤„ç†
                    if (fileBrowser.path.match(/^[A-Z]:/i)) {
                        crumbs.push({ name: parts[0], path: parts[0] + '\\' });
                        for (let i = 1; i < parts.length; i++) {
                            crumbs.push({
                                name: parts[i],
                                path: parts.slice(0, i + 1).join('\\')
                            });
                        }
                    } else {
                        // Unix-like è·¯å¾„
                        crumbs.push({ name: 'æ ¹ç›®å½•', path: '/' });
                        for (let i = 0; i < parts.length; i++) {
                            crumbs.push({
                                name: parts[i],
                                path: '/' + parts.slice(0, i + 1).join('/')
                            });
                        }
                    }

                    return crumbs;
                });

                const canGoUp = computed(() => {
                    if (!fileBrowser.path) return false;
                    // Windows æ ¹ç›®å½• (C:\) æˆ– Unix æ ¹ç›®å½• (/) æ— æ³•å†ä¸Šçº§
                    return !fileBrowser.path.match(/^[A-Z]:[\\\/]?$/i) && fileBrowser.path !== '/';
                });

                // API è°ƒç”¨å°è£…
                async function api(path, options = {}) {
                    try {
                        const response = await fetch(`/api${path}`, {
                            headers: {
                                'Content-Type': 'application/json',
                                ...options.headers
                            },
                            ...options
                        });

                        const result = await response.json();

                        if (result.code !== undefined) {
                            if (result.code !== 0) {
                                throw new Error(result.msg || `é”™è¯¯ä»£ç : ${result.code}`);
                            }

                            if (result.msg && (result.msg.includes('æš‚ä¸å¯ç”¨') || result.msg.includes('éœ€è¦') || result.msg.includes('å ä½ç¬¦'))) {
                                state.placeholderWarning = result.msg;
                            }

                            return result.data;
                        } else if (!response.ok) {
                            throw new Error(result.detail || `HTTP ${response.status}`);
                        }

                        return result;
                    } catch (error) {
                        console.error('API é”™è¯¯:', error);
                        state.error = error.message;
                        throw error;
                    }
                }

                // åŠ è½½æœ€è¿‘æ–‡ä»¶
                async function loadRecentFiles() {
                    try {
                        state.loading = true;
                        const data = await api('/recent-files');
                        const files = data.files || [];
                        files.sort((a, b) => String(b.last_opened).localeCompare(String(a.last_opened)));
                        state.recentFiles = files;
                    } catch (error) {
                        console.error('åŠ è½½æœ€è¿‘æ–‡ä»¶å¤±è´¥:', error);
                    } finally {
                        state.loading = false;
                    }
                }

                // æ–‡ä»¶æµè§ˆå™¨ç›¸å…³å‡½æ•°
                async function openFileBrowser() {
                    fileBrowser.visible = true;
                    fileBrowser.loading = true;
                    try {
                        // è·å–æœ€åæµè§ˆçš„ç›®å½•
                        const data = await api('/last-browse-directory');
                        const directory = data.directory;
                        await browseTo(directory);
                    } catch (error) {
                        state.error = `æ— æ³•æ‰“å¼€æ–‡ä»¶æµè§ˆå™¨: ${error.message}`;
                    } finally {
                        fileBrowser.loading = false;
                    }
                }

                function closeFileBrowser() {
                    fileBrowser.visible = false;
                }

                async function browseTo(path) {
                    fileBrowser.loading = true;
                    try {
                        const data = await api(`/browse-directory?path=${encodeURIComponent(path)}`);
                        fileBrowser.path = data.path;
                        fileBrowser.pathInput = data.path;
                        fileBrowser.entries = data.entries || [];
                    } catch (error) {
                        state.error = error.message;
                    } finally {
                        fileBrowser.loading = false;
                    }
                }

                async function goToPath() {
                    if (!fileBrowser.pathInput.trim()) return;
                    await browseTo(fileBrowser.pathInput.trim());
                }

                async function goUp() {
                    if (!canGoUp.value) return;

                    const currentPath = fileBrowser.path;
                    let parentPath;

                    if (currentPath.match(/^[A-Z]:[\\\/]/i)) {
                        // Windows è·¯å¾„
                        const parts = currentPath.split(/[\\\/]/).filter(p => p);
                        if (parts.length === 1) {
                            parentPath = parts[0] + '\\';
                        } else {
                            parentPath = parts.slice(0, -1).join('\\');
                        }
                    } else {
                        // Unix-like è·¯å¾„
                        const parts = currentPath.split('/').filter(p => p);
                        parentPath = '/' + parts.slice(0, -1).join('/');
                        if (!parentPath || parentPath === '/') parentPath = '/';
                    }

                    await browseTo(parentPath);
                }

                async function goToBreadcrumb(index) {
                    const crumb = breadcrumbs.value[index];
                    if (crumb) {
                        await browseTo(crumb.path);
                    }
                }

                async function selectAndOpenFile(filePath) {
                    closeFileBrowser();
                    await openFile(filePath);
                }

                async function removeHistory(fileId) {
                    try {
                        state.loading = true;
                        await api(`/recent-files/${fileId}`, { method: 'DELETE' });

                        if (state.currentDatabase && state.currentDatabase.file_id === fileId) {
                            backToFileSelector();
                        }

                        await loadRecentFiles();
                    } catch (error) {
                        state.error = `ç§»é™¤å¤±è´¥: ${error.message}`;
                    } finally {
                        state.loading = false;
                    }
                }

                // æ‰“å¼€æ–‡ä»¶
                async function openFile(filePath) {
                    try {
                        state.loading = true;
                        state.error = null;
                        state.placeholderWarning = null;

                        const data = await api('/open-file', {
                            method: 'POST',
                            body: JSON.stringify({ path: filePath })
                        });

                        state.currentDatabase = data;
                        state.currentPage = 'database-view';

                        await loadTables();

                    } catch (error) {
                        state.error = `æ‰“å¼€æ–‡ä»¶å¤±è´¥: ${error.message}`;
                    } finally {
                        state.loading = false;
                    }
                }

                // åŠ è½½è¡¨åˆ—è¡¨
                async function loadTables() {
                    if (!state.currentDatabase) return;

                    try {
                        const data = await api(`/tables/${state.currentDatabase.file_id}`);
                        state.tables = data.tables || [];

                        if (data.has_placeholder) {
                            state.placeholderWarning = 'éƒ¨åˆ†åŠŸèƒ½éœ€è¦ pytuck åº“æ”¯æŒï¼Œè¡¨åˆ—è¡¨å¯èƒ½ä¸å®Œæ•´';
                        }
                    } catch (error) {
                        console.error('åŠ è½½è¡¨åˆ—è¡¨å¤±è´¥:', error);
                    }
                }

                // é€‰æ‹©è¡¨
                async function selectTable(tableName) {
                    try {
                        state.loading = true;
                        state.currentTable = tableName;
                        state.currentPageNum = 1;
                        state.activeTab = 'structure';

                        await loadTableSchema(tableName);

                        state.tableData = [];
                        state.totalRows = 0;

                    } catch (error) {
                        state.error = `åŠ è½½è¡¨æ•°æ®å¤±è´¥: ${error.message}`;
                    } finally {
                        state.loading = false;
                    }
                }

                // åŠ è½½è¡¨ç»“æ„
                async function loadTableSchema(tableName) {
                    if (!state.currentDatabase) return;

                    const data = await api(`/schema/${state.currentDatabase.file_id}/${tableName}`);
                    state.tableSchema = data;

                    if (data.columns && data.columns.some(col => col.name && col.name.startsWith('âš ï¸'))) {
                        state.placeholderWarning = 'è¡¨ç»“æ„åŠŸèƒ½éœ€è¦ pytuck åº“å®Œå–„ï¼Œåˆ—ä¿¡æ¯å¯èƒ½ä¸å‡†ç¡®';
                    }
                }

                // åŠ è½½è¡¨æ•°æ®
                async function loadTableData(tableName, page = 1) {
                    if (!state.currentDatabase) return;

                    const params = new URLSearchParams({
                        page: page.toString(),
                        limit: state.rowsPerPage.toString()
                    });

                    if (state.sortBy) {
                        params.append('sort', state.sortBy);
                        params.append('order', state.sortOrder);
                    }

                    const data = await api(
                        `/rows/${state.currentDatabase.file_id}/${tableName}?${params}`
                    );

                    state.tableData = data.rows || [];
                    state.totalRows = data.total || 0;
                    state.currentPageNum = data.page || 1;

                    if (data.rows && data.rows.length > 0 && data.rows[0].is_placeholder) {
                        state.placeholderWarning = 'æ•°æ®æŸ¥è¯¢åŠŸèƒ½æš‚ä¸å¯ç”¨ï¼Œéœ€è¦ pytuck åº“æ”¯æŒ';
                    }
                }

                async function switchToDataTab() {
                    if (!state.currentTable) {
                        state.activeTab = 'data';
                        return;
                    }

                    state.activeTab = 'data';
                    if (!state.tableData || state.tableData.length === 0) {
                        await loadTableData(state.currentTable, state.currentPageNum || 1);
                    }
                }

                // æ’åº
                async function sortTable(columnName) {
                    if (state.sortBy === columnName) {
                        state.sortOrder = state.sortOrder === 'asc' ? 'desc' : 'asc';
                    } else {
                        state.sortBy = columnName;
                        state.sortOrder = 'asc';
                    }

                    if (state.currentTable) {
                        await loadTableData(state.currentTable, state.currentPageNum);
                    }
                }

                // åˆ†é¡µ
                async function goToPage(page) {
                    if (page < 1 || page > totalPages.value || !state.currentTable) return;

                    state.activeTab = 'data';
                    await loadTableData(state.currentTable, page);
                }

                // è¿”å›æ–‡ä»¶é€‰æ‹©é¡µé¢
                async function backToFileSelector() {
                    state.currentPage = 'file-selector';
                    state.currentDatabase = null;
                    state.tables = [];
                    state.currentTable = null;
                    state.activeTab = 'structure';
                    state.tableSchema = null;
                    state.tableData = [];
                    state.totalRows = 0;
                    state.currentPageNum = 1;

                    // åˆ·æ–°å†å²æ–‡ä»¶åˆ—è¡¨
                    await loadRecentFiles();
                }

                // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
                function formatFileSize(bytes) {
                    if (bytes === 0 || bytes === null) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                }

                // æ ¼å¼åŒ–æ—¥æœŸ
                function formatDate(isoString) {
                    const date = new Date(isoString);
                    return date.toLocaleString('zh-CN');
                }

                // åˆå§‹åŒ–
                onMounted(async () => {
                    await loadRecentFiles();
                });

                return {
                    state,
                    fileBrowser,
                    totalPages,
                    hasData,
                    breadcrumbs,
                    canGoUp,
                    openFile,
                    removeHistory,
                    switchToDataTab,
                    selectTable,
                    sortTable,
                    goToPage,
                    backToFileSelector,
                    formatFileSize,
                    formatDate,
                    loadRecentFiles,
                    openFileBrowser,
                    closeFileBrowser,
                    browseTo,
                    goToPath,
                    goUp,
                    goToBreadcrumb,
                    selectAndOpenFile
                };
            }
        }).mount('#app');
    </script>

</body>
</html>
