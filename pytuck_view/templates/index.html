<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pytuck-view - æ•°æ®åº“æŸ¥çœ‹å™¨</title>
    <link rel="stylesheet" href="/static/app.css">
    <style>
        /* å†…è”å…³é”® CSS ä»¥åŠ å¿«åŠ è½½é€Ÿåº¦ */
        #app {
            min-height: 100vh;
        }
    </style>
</head>
<body>
    {% raw %}
    <div id="app">
        <!-- æ–‡ä»¶é€‰æ‹©å™¨é¡µé¢ -->
        <div v-if="state.currentPage === 'file-selector'" class="file-selector">
            <header class="header">
                <h1>ğŸ“Š pytuck-view</h1>
                <p>é€‰æ‹©ä¸€ä¸ª pytuck æ•°æ®åº“æ–‡ä»¶å¼€å§‹æµè§ˆ</p>
            </header>

            <!-- é”™è¯¯æç¤º -->
            <div v-if="state.error" class="error">
                âŒ {{ state.error }}
                <button @click="state.error = null">Ã—</button>
            </div>

            <!-- å ä½ç¬¦åŠŸèƒ½è­¦å‘Š -->
            <div v-if="state.placeholderWarning" class="warning">
                âš ï¸ {{ state.placeholderWarning }}
                <button @click="state.placeholderWarning = null">Ã—</button>
            </div>

            <!-- å¿«é€Ÿæ“ä½œ -->
            <div class="quick-actions">
                <button @click="triggerFileDialog" class="btn btn-primary">
                    ğŸ“ é€‰æ‹©æ–‡ä»¶
                </button>
                <button @click="discoverFiles" class="btn btn-secondary" :disabled="state.loading">
                    ğŸ” æ‰«æå½“å‰ç›®å½•
                </button>
            </div>

            <!-- æœ€è¿‘æ–‡ä»¶ -->
            <section v-if="state.recentFiles.length > 0" class="file-section">
                <h2>ğŸ“‹ æœ€è¿‘æ‰“å¼€</h2>
                <div class="file-list">
                    <div v-for="file in state.recentFiles" :key="file.file_id"
                         class="file-item" @click="openFile(file.path)">
                        <div class="file-info">
                            <div class="file-name">{{ file.name }}</div>
                            <div class="file-path">{{ file.path }}</div>
                            <div class="file-meta">
                                {{ formatFileSize(file.file_size) }} â€¢ {{ formatDate(file.last_opened) }}
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- å‘ç°çš„æ–‡ä»¶ -->
            <section v-if="state.discoveredFiles.length > 0" class="file-section">
                <h2>ğŸ“ å½“å‰ç›®å½•</h2>
                <div class="file-list">
                    <div v-for="file in state.discoveredFiles" :key="file.path"
                         class="file-item" @click="openFile(file.path)">
                        <div class="file-info">
                            <div class="file-name">{{ file.name }}{{ file.extension }}</div>
                            <div class="file-path">{{ file.path }}</div>
                            <div class="file-meta">
                                {{ formatFileSize(file.size) }}
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ç©ºçŠ¶æ€ -->
            <div v-if="!state.loading && state.recentFiles.length === 0 && state.discoveredFiles.length === 0"
                 class="empty-state">
                <p>ğŸ” æœªå‘ç° pytuck æ•°æ®åº“æ–‡ä»¶</p>
                <p>æ”¯æŒçš„æ ¼å¼ï¼š.bin, .json, .csv</p>
            </div>
        </div>

        <!-- æ•°æ®åº“æŸ¥çœ‹é¡µé¢ -->
        <div v-else-if="state.currentPage === 'database-view'" class="database-view">
            <header class="header">
                <button @click="backToFileSelector" class="btn btn-back">â† è¿”å›</button>
                <div class="db-info">
                    <h1>ğŸ“Š {{ state.currentDatabase.name }}</h1>
                    <p>{{ state.currentDatabase.tables_count }} å¼ è¡¨ â€¢ {{ formatFileSize(state.currentDatabase.file_size) }}</p>
                </div>
            </header>

            <!-- å ä½ç¬¦åŠŸèƒ½è­¦å‘Šï¼ˆæ•°æ®åº“é¡µé¢ï¼‰ -->
            <div v-if="state.placeholderWarning" class="warning">
                âš ï¸ {{ state.placeholderWarning }}
                <button @click="state.placeholderWarning = null">Ã—</button>
            </div>

            <div class="main-content">
                <!-- ä¾§è¾¹æ  - è¡¨åˆ—è¡¨ -->
                <aside class="sidebar">
                    <h3>ğŸ“‹ æ•°æ®è¡¨</h3>
                    <div class="table-list">
                        <div v-for="table in state.tables" :key="table"
                             class="table-item"
                             :class="{
                                active: state.currentTable === table,
                                placeholder: table.startsWith('âš ï¸') || table.startsWith('ğŸ’¡') || table.startsWith('ğŸ“‹')
                             }"
                             @click="selectTable(table)">
                            {{ table }}
                        </div>
                    </div>
                </aside>

                <!-- ä¸»å†…å®¹åŒº -->
                <main class="content">
                    <div v-if="!state.currentTable" class="welcome">
                        <h2>ğŸ‘ˆ é€‰æ‹©ä¸€ä¸ªè¡¨å¼€å§‹æµè§ˆ</h2>
                    </div>

                    <div v-else>
                        <!-- è¡¨ä¿¡æ¯ -->
                        <div v-if="state.tableSchema" class="table-info">
                            <h2>ğŸ“Š {{ state.tableSchema.table_name }}</h2>
                            <p>{{ state.tableSchema.row_count }} è¡Œæ•°æ®</p>
                        </div>

                        <!-- è¡¨ç»“æ„ -->
                        <div v-if="state.tableSchema && state.tableSchema.columns" class="schema">
                            <h3>ğŸ”§ è¡¨ç»“æ„</h3>
                            <div class="columns">
                                <div v-for="col in state.tableSchema.columns" :key="col.name" class="column">
                                    <span class="col-name">{{ col.name }}</span>
                                    <span class="col-type">{{ col.type }}</span>
                                    <span v-if="col.primary_key" class="col-pk">ğŸ”‘</span>
                                </div>
                            </div>
                        </div>

                        <!-- æ•°æ®è¡¨æ ¼ -->
                        <div v-if="hasData" class="data-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th v-for="col in state.tableSchema.columns" :key="col.name"
                                            @click="sortTable(col.name)"
                                            class="sortable">
                                            {{ col.name }}
                                            <span v-if="state.sortBy === col.name">
                                                <span v-if="state.sortOrder === 'asc'">â†‘</span>
                                                <span v-else>â†“</span>
                                            </span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="(row, index) in state.tableData" :key="index">
                                        <td v-for="col in state.tableSchema.columns" :key="col.name">
                                            {{ row[col.name] }}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- åˆ†é¡µ -->
                        <div v-if="totalPages > 1" class="pagination">
                            <button @click="goToPage(1)" :disabled="state.currentPageNum === 1">é¦–é¡µ</button>
                            <button @click="goToPage(state.currentPageNum - 1)" :disabled="state.currentPageNum === 1">ä¸Šä¸€é¡µ</button>
                            <span>ç¬¬ {{ state.currentPageNum }} / {{ totalPages }} é¡µ</span>
                            <button @click="goToPage(state.currentPageNum + 1)" :disabled="state.currentPageNum === totalPages">ä¸‹ä¸€é¡µ</button>
                            <button @click="goToPage(totalPages)" :disabled="state.currentPageNum === totalPages">å°¾é¡µ</button>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <!-- å…¨å±€åŠ è½½çŠ¶æ€ -->
        <div v-if="state.loading" class="loading-overlay">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>
    {% endraw %}

    <!-- Vue.js 3.x æœ¬åœ°æ–‡ä»¶ -->
    <script src="/static/vue.min.js"></script>

    <script>
        const { createApp, ref, reactive, computed, onMounted, nextTick } = Vue;

        createApp({
            setup() {
                // å“åº”å¼æ•°æ®
                const state = reactive({
                    currentPage: 'file-selector', // 'file-selector', 'database-view'
                    recentFiles: [],
                    discoveredFiles: [],
                    currentDatabase: null,
                    tables: [],
                    currentTable: null,
                    tableSchema: null,
                    tableData: [],
                    currentPageNum: 1,
                    totalRows: 0,
                    rowsPerPage: 50,
                    loading: false,
                    error: null,
                    placeholderWarning: null,  // æ–°å¢ï¼šå ä½ç¬¦åŠŸèƒ½è­¦å‘Š
                    sortBy: null,
                    sortOrder: 'asc'
                });

                // è®¡ç®—å±æ€§
                const totalPages = computed(() => {
                    return Math.ceil(state.totalRows / state.rowsPerPage);
                });

                const hasData = computed(() => {
                    return state.tableData && state.tableData.length > 0;
                });

                // API è°ƒç”¨å°è£… - å¤„ç†æ–°çš„ {code, msg, data} æ ¼å¼
                async function api(path, options = {}) {
                    try {
                        const response = await fetch(`/api${path}`, {
                            headers: {
                                'Content-Type': 'application/json',
                                ...options.headers
                            },
                            ...options
                        });

                        const result = await response.json();

                        // å¤„ç†æ–°çš„ {code, msg, data} æ ¼å¼
                        if (result.code !== undefined) {
                            if (result.code !== 200) {
                                throw new Error(result.msg || `é”™è¯¯ä»£ç : ${result.code}`);
                            }

                            // æ£€æŸ¥æ˜¯å¦æœ‰å ä½ç¬¦åŠŸèƒ½çš„è­¦å‘Š
                            if (result.msg && (result.msg.includes('æš‚ä¸å¯ç”¨') || result.msg.includes('éœ€è¦') || result.msg.includes('å ä½ç¬¦'))) {
                                state.placeholderWarning = result.msg;
                            }

                            return result.data;
                        } else if (!response.ok) {
                            // å…¼å®¹è€æ ¼å¼
                            throw new Error(result.detail || `HTTP ${response.status}`);
                        }

                        return result;
                    } catch (error) {
                        console.error('API é”™è¯¯:', error);
                        state.error = error.message;
                        throw error;
                    }
                }

                // åŠ è½½æœ€è¿‘æ–‡ä»¶
                async function loadRecentFiles() {
                    try {
                        state.loading = true;
                        const data = await api('/recent-files');
                        state.recentFiles = data.files || [];
                    } catch (error) {
                        console.error('åŠ è½½æœ€è¿‘æ–‡ä»¶å¤±è´¥:', error);
                    } finally {
                        state.loading = false;
                    }
                }

                // å‘ç°å½“å‰ç›®å½•æ–‡ä»¶
                async function discoverFiles() {
                    try {
                        state.loading = true;
                        const data = await api('/discover-files');
                        state.discoveredFiles = data.files || [];
                    } catch (error) {
                        console.error('å‘ç°æ–‡ä»¶å¤±è´¥:', error);
                    } finally {
                        state.loading = false;
                    }
                }

                // æ‰“å¼€æ–‡ä»¶
                async function openFile(filePath) {
                    try {
                        state.loading = true;
                        state.error = null;
                        state.placeholderWarning = null;

                        const data = await api('/open-file', {
                            method: 'POST',
                            body: JSON.stringify({ path: filePath })
                        });

                        state.currentDatabase = data;
                        state.currentPage = 'database-view';

                        // ç«‹å³åŠ è½½è¡¨åˆ—è¡¨
                        await loadTables();

                    } catch (error) {
                        state.error = `æ‰“å¼€æ–‡ä»¶å¤±è´¥: ${error.message}`;
                    } finally {
                        state.loading = false;
                    }
                }

                // åŠ è½½è¡¨åˆ—è¡¨
                async function loadTables() {
                    if (!state.currentDatabase) return;

                    try {
                        const data = await api(`/tables/${state.currentDatabase.file_id}`);
                        state.tables = data.tables || [];

                        // æ£€æŸ¥æ˜¯å¦æœ‰å ä½ç¬¦è¡¨
                        if (data.has_placeholder) {
                            state.placeholderWarning = 'éƒ¨åˆ†åŠŸèƒ½éœ€è¦ pytuck åº“æ”¯æŒï¼Œè¡¨åˆ—è¡¨å¯èƒ½ä¸å®Œæ•´';
                        }
                    } catch (error) {
                        console.error('åŠ è½½è¡¨åˆ—è¡¨å¤±è´¥:', error);
                    }
                }

                // é€‰æ‹©è¡¨
                async function selectTable(tableName) {
                    try {
                        state.loading = true;
                        state.currentTable = tableName;
                        state.currentPageNum = 1;

                        // å¹¶è¡ŒåŠ è½½è¡¨ç»“æ„å’Œæ•°æ®
                        await Promise.all([
                            loadTableSchema(tableName),
                            loadTableData(tableName, 1)
                        ]);

                    } catch (error) {
                        state.error = `åŠ è½½è¡¨æ•°æ®å¤±è´¥: ${error.message}`;
                    } finally {
                        state.loading = false;
                    }
                }

                // åŠ è½½è¡¨ç»“æ„
                async function loadTableSchema(tableName) {
                    if (!state.currentDatabase) return;

                    const data = await api(`/schema/${state.currentDatabase.file_id}/${tableName}`);
                    state.tableSchema = data;

                    // æ£€æŸ¥æ˜¯å¦æœ‰å ä½ç¬¦åˆ—
                    if (data.columns && data.columns.some(col => col.name && col.name.startsWith('âš ï¸'))) {
                        state.placeholderWarning = 'è¡¨ç»“æ„åŠŸèƒ½éœ€è¦ pytuck åº“å®Œå–„ï¼Œåˆ—ä¿¡æ¯å¯èƒ½ä¸å‡†ç¡®';
                    }
                }

                // åŠ è½½è¡¨æ•°æ®
                async function loadTableData(tableName, page = 1) {
                    if (!state.currentDatabase) return;

                    const params = new URLSearchParams({
                        page: page.toString(),
                        limit: state.rowsPerPage.toString()
                    });

                    if (state.sortBy) {
                        params.append('sort', state.sortBy);
                        params.append('order', state.sortOrder);
                    }

                    const data = await api(
                        `/rows/${state.currentDatabase.file_id}/${tableName}?${params}`
                    );

                    state.tableData = data.rows || [];
                    state.totalRows = data.total || 0;
                    state.currentPageNum = data.page || 1;

                    // æ£€æŸ¥æ˜¯å¦æ˜¯å ä½ç¬¦æ•°æ®
                    if (data.rows && data.rows.length > 0 &&
                        data.rows[0].message && data.rows[0].message.includes('âš ï¸')) {
                        state.placeholderWarning = 'æ•°æ®æŸ¥è¯¢åŠŸèƒ½æš‚ä¸å¯ç”¨ï¼Œéœ€è¦ pytuck åº“æ”¯æŒ';
                    }
                }

                // æ’åº
                async function sortTable(columnName) {
                    if (state.sortBy === columnName) {
                        state.sortOrder = state.sortOrder === 'asc' ? 'desc' : 'asc';
                    } else {
                        state.sortBy = columnName;
                        state.sortOrder = 'asc';
                    }

                    if (state.currentTable) {
                        await loadTableData(state.currentTable, state.currentPageNum);
                    }
                }

                // åˆ†é¡µ
                async function goToPage(page) {
                    if (page < 1 || page > totalPages.value || !state.currentTable) return;

                    await loadTableData(state.currentTable, page);
                }

                // è¿”å›æ–‡ä»¶é€‰æ‹©é¡µé¢
                function backToFileSelector() {
                    state.currentPage = 'file-selector';
                    state.currentDatabase = null;
                    state.tables = [];
                    state.currentTable = null;
                    state.tableSchema = null;
                    state.tableData = [];
                }

                // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
                function formatFileSize(bytes) {
                    if (bytes === 0) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                }

                // æ ¼å¼åŒ–æ—¥æœŸ
                function formatDate(isoString) {
                    const date = new Date(isoString);
                    return date.toLocaleString('zh-CN');
                }

                // è§¦å‘æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
                function triggerFileDialog() {
                    alert('æ–‡ä»¶é€‰æ‹©åŠŸèƒ½éœ€è¦åœ¨æ¡Œé¢ç¯å¢ƒä¸­è¿è¡Œã€‚è¯·ç›´æ¥å°†æ–‡ä»¶æ‹–æ‹½åˆ°å½“å‰ç›®å½•ï¼Œç„¶åç‚¹å‡»"æ‰«æå½“å‰ç›®å½•"ã€‚');
                }

                // åˆå§‹åŒ–
                onMounted(async () => {
                    await Promise.all([
                        loadRecentFiles(),
                        discoverFiles()
                    ]);
                });

                return {
                    state,
                    totalPages,
                    hasData,
                    openFile,
                    selectTable,
                    sortTable,
                    goToPage,
                    backToFileSelector,
                    triggerFileDialog,
                    formatFileSize,
                    formatDate,
                    loadRecentFiles,
                    discoverFiles
                };
            }
        }).mount('#app');
    </script>

</body>
</html>